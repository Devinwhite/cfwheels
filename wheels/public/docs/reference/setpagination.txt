
<span class="cm-s-neo"><span class="cm-comment">//</span> <span class="cm-comment">Note that there are two ways to do pagination yourself using</span> <span class="cm-comment">a custom query.</span> <span class="cm-comment">1) Do a query that grabs everything that matches and then use</span> <span class="cm-comment">the `cfouput` or `cfloop` tag to page through the results.</span> <span class="cm-comment">2) Use your database to make 2 queries. The first query</span> <span class="cm-comment">basically does a count of the total number of records that match</span> <span class="cm-comment">the criteria and the second query actually selects the page of</span> <span class="cm-comment">records for retrieval.</span> <span class="cm-comment">In the example below, we will show how to write a custom query</span> <span class="cm-comment">using both of these methods. Note that the syntax where your</span> <span class="cm-comment">database performs the pagination will differ depending on the</span> <span class="cm-comment">database engine you are using. Plese consult your database</span> <span class="cm-comment">engine''s documentation for the correct syntax.</span> <span class="cm-comment">Also note that the view code will differ depending on the method</span> <span class="cm-comment">used.</span> <span class="cm-comment"></span> <span class="cm-comment">//</span> <span class="cm-comment">First method: Handle the pagination through your CFML engine</span> <span class="cm-comment"></span> <span class="cm-comment">//</span> <span class="cm-comment">Model code</span> <span class="cm-comment">In your model (ie. User.cfc), create a custom method for your</span> <span class="cm-comment">custom query</span> <span class="cm-comment"></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cffunction</span> <span class="cm-attribute">name</span>=<span class="cm-string">"myCustomQuery"</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfargument</span> <span class="cm-attribute">name</span>=<span class="cm-string">"page"</span> <span class="cm-attribute">type</span>=<span class="cm-string">"numeric"</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfargument</span> <span class="cm-attribute">name</span>=<span class="cm-string">"perPage"</span> <span class="cm-attribute">type</span>=<span class="cm-string">"numeric"</span> <span class="cm-attribute">required</span>=<span class="cm-string">"false"</span> <span class="cm-attribute">default</span>=<span class="cm-string">"25"</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfquery</span> <span class="cm-attribute">name</span>=<span class="cm-string">"local.customQuery"</span> <span class="cm-attribute">datasource</span>=<span class="cm-string">"##get(''dataSourceName'')##"</span><span class="cm-tag cm-bracket">></span> SELECT * FROM users <span class="cm-tag cm-bracket"></</span><span class="cm-tag">cfquery</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfset</span> <span class="cm-attribute">setPagination(</span> <span class="cm-attribute">totalRecords</span>=<span class="cm-string">local.customQuery.RecordCount,</span> <span class="cm-attribute">currentPage</span>=<span class="cm-string">arguments.page,</span> <span class="cm-attribute">perPage</span>=<span class="cm-string">arguments.perPage,</span> <span class="cm-attribute">handle</span>=<span class="cm-string">"myCustomQueryHandle"</span> <span class="cm-attribute">)</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfreturn</span> <span class="cm-attribute">customQuery</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"></</span><span class="cm-tag cm-error">cffunction</span><span class="cm-tag cm-bracket cm-error">></span> <span class="cm-comment">// Controller code </span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cffunction</span> <span class="cm-attribute">name</span>=<span class="cm-string">"list"</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfparam</span> <span class="cm-attribute">name</span>=<span class="cm-string">"params.page"</span> <span class="cm-attribute">default</span>=<span class="cm-string">"1"</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfparam</span> <span class="cm-attribute">name</span>=<span class="cm-string">"params.perPage"</span> <span class="cm-attribute">default</span>=<span class="cm-string">"25"</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfset</span> <span class="cm-attribute">allUsers</span> = <span class="cm-string">model(</span><span class="cm-string cm-error">"user"</span><span class="cm-attribute">).myCustomQuery(</span> <span class="cm-attribute">page</span>=<span class="cm-string">params.page,</span> <span class="cm-attribute">perPage</span>=<span class="cm-string">params.perPage</span> <span class="cm-attribute">)</span><span class="cm-tag cm-bracket">></span> <span class="cm-comment">//</span> <span class="cm-comment">Because we're going to let `cfoutput`/`cfloop` handle the</span> <span class="cm-comment">pagination, we're going to need to get some addition information</span> <span class="cm-comment">about the pagination.</span> <span class="cm-comment"></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfset</span> <span class="cm-attribute">paginationData</span> = <span class="cm-string">pagination(</span><span class="cm-string cm-error">"myCustomQueryHandle"</span><span class="cm-attribute">)</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"></</span><span class="cm-tag cm-error">cffunction</span><span class="cm-tag cm-bracket cm-error">></span> <span class="cm-comment">//</span> <span class="cm-comment">View code (using `cfloop`)</span> <span class="cm-comment">Use the information from `paginationData` to page through the</span> <span class="cm-comment">records</span> <span class="cm-comment"></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfoutput</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">ul</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfloop</span> <span class="cm-attribute">query</span>=<span class="cm-string">"allUsers"</span> <span class="cm-attribute">startrow</span>=<span class="cm-string">"#paginationData.startrow#"</span> <span class="cm-attribute">endrow</span>=<span class="cm-string">"#paginationData.endrow#"</span> <span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">li</span><span class="cm-tag cm-bracket">></span> #allUsers.firstName# #allUsers.lastName# <span class="cm-tag cm-bracket"></</span><span class="cm-tag">li</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"></</span><span class="cm-tag">cfloop</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"></</span><span class="cm-tag">ul</span><span class="cm-tag cm-bracket">></span> #paginationLinks(handle="myCustomQueryHandle")# <span class="cm-tag cm-bracket"></</span><span class="cm-tag">cfoutput</span><span class="cm-tag cm-bracket">></span> <span class="cm-comment">//</span> <span class="cm-comment">View code (using `cfoutput`)</span> <span class="cm-comment">Use the information from `paginationData` to page through the</span> <span class="cm-comment">records</span> <span class="cm-comment"></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">ul</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfoutput</span> <span class="cm-attribute">query</span>=<span class="cm-string">"allUsers"</span> <span class="cm-attribute">startrow</span>=<span class="cm-string">"#paginationData.startrow#"</span> <span class="cm-attribute">maxrows</span>=<span class="cm-string">"#paginationData.maxrows#"</span> <span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">li</span><span class="cm-tag cm-bracket">></span> #allUsers.firstName# #allUsers.lastName# <span class="cm-tag cm-bracket"></</span><span class="cm-tag">li</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"></</span><span class="cm-tag">cfoutput</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"></</span><span class="cm-tag">ul</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfoutput</span><span class="cm-tag cm-bracket">></span> #paginationLinks(handle="myCustomQueryHandle")# <span class="cm-tag cm-bracket"></</span><span class="cm-tag">cfoutput</span><span class="cm-tag cm-bracket">></span> <span class="cm-comment">//</span> <span class="cm-comment">Second method: Handle the pagination through the database</span> <span class="cm-comment"></span> <span class="cm-comment">//</span> <span class="cm-comment">Model code</span> <span class="cm-comment">In your model (ie. `User.cfc`), create a custom method for</span> <span class="cm-comment">your custom query</span> <span class="cm-comment"></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cffunction</span> <span class="cm-attribute">name</span>=<span class="cm-string">"myCustomQuery"</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfargument</span> <span class="cm-attribute">name</span>=<span class="cm-string">"page"</span> <span class="cm-attribute">type</span>=<span class="cm-string">"numeric"</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfargument</span> <span class="cm-attribute">name</span>=<span class="cm-string">"perPage"</span> <span class="cm-attribute">type</span>=<span class="cm-string">"numeric"</span> <span class="cm-attribute">required</span>=<span class="cm-string">"false"</span> <span class="cm-attribute">default</span>=<span class="cm-string">"25"</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfquery</span> <span class="cm-attribute">name</span>=<span class="cm-string">"local.customQueryCount"</span> <span class="cm-attribute">datasource</span>=<span class="cm-string">"#get('dataSouceName')#"</span> <span class="cm-tag cm-bracket">></span> SELECT COUNT(*) AS theCount FROM users <span class="cm-tag cm-bracket"></</span><span class="cm-tag">cfquery</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfquery</span> <span class="cm-attribute">name</span>=<span class="cm-string">"local.customQuery"</span> <span class="cm-attribute">datasource</span>=<span class="cm-string">"#get('dataSourceName')#"</span> <span class="cm-tag cm-bracket">></span> SELECT * FROM users LIMIT #arguments.page# OFFSET #arguments.perPage# <span class="cm-tag cm-bracket"></</span><span class="cm-tag">cfquery</span><span class="cm-tag cm-bracket">></span> <span class="cm-comment">//</span> <span class="cm-comment">Notice the we use the value from the first query for</span> <span class="cm-comment">`totalRecords`</span> <span class="cm-comment"></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfset</span> <span class="cm-attribute">setPagination(</span> <span class="cm-attribute">totalRecords</span>=<span class="cm-string">local.customQueryCount.theCount,</span> <span class="cm-attribute">currentPage</span>=<span class="cm-string">arguments.page,</span> <span class="cm-attribute">perPage</span>=<span class="cm-string">arguments.perPage,</span> <span class="cm-attribute">handle</span>=<span class="cm-string">"myCustomQueryHandle"</span> <span class="cm-attribute">)</span><span class="cm-tag cm-bracket">></span> <span class="cm-comment">// We return the second query </span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfreturn</span> <span class="cm-attribute">customQuery</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"></</span><span class="cm-tag cm-error">cffunction</span><span class="cm-tag cm-bracket cm-error">></span> <span class="cm-comment">// Controller code </span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cffunction</span> <span class="cm-attribute">name</span>=<span class="cm-string">"list"</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfparam</span> <span class="cm-attribute">name</span>=<span class="cm-string">"params.page"</span> <span class="cm-attribute">default</span>=<span class="cm-string">"1"</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfparam</span> <span class="cm-attribute">name</span>=<span class="cm-string">"params.perPage"</span> <span class="cm-attribute">default</span>=<span class="cm-string">"25"</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfset</span> <span class="cm-attribute">allUsers</span> = <span class="cm-string">model(</span><span class="cm-string cm-error">"user"</span><span class="cm-attribute">).myCustomQuery(</span> <span class="cm-attribute">page</span>=<span class="cm-string">params.page,</span> <span class="cm-attribute">perPage</span>=<span class="cm-string">params.perPage</span> <span class="cm-attribute">)</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"></</span><span class="cm-tag cm-error">cffunction</span><span class="cm-tag cm-bracket cm-error">></span> <span class="cm-comment">// View code (using `cfloop`) </span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfoutput</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">ul</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfloop</span> <span class="cm-attribute">query</span>=<span class="cm-string">"allUsers"</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">li</span><span class="cm-tag cm-bracket">></span> #allUsers.firstName# #allUsers.lastName# <span class="cm-tag cm-bracket"></</span><span class="cm-tag">li</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"></</span><span class="cm-tag">cfloop</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"></</span><span class="cm-tag">ul</span><span class="cm-tag cm-bracket">></span> #paginationLinks(handle="myCustomQueryHandle")# <span class="cm-tag cm-bracket"></</span><span class="cm-tag">cfoutput</span><span class="cm-tag cm-bracket">></span> <span class="cm-comment">// View code (using `cfoutput`) </span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">ul</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfoutput</span> <span class="cm-attribute">query</span>=<span class="cm-string">"allUsers"</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">li</span><span class="cm-tag cm-bracket">></span> #allUsers.firstName# #allUsers.lastName# <span class="cm-tag cm-bracket"></</span><span class="cm-tag">li</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"></</span><span class="cm-tag">cfoutput</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"></</span><span class="cm-tag">ul</span><span class="cm-tag cm-bracket">></span> <span class="cm-tag cm-bracket"><</span><span class="cm-tag">cfoutput</span><span class="cm-tag cm-bracket">></span> #paginationLinks(handle="myCustomQueryHandle")# <span class="cm-tag cm-bracket"></</span><span class="cm-tag">cfoutput</span><span class="cm-tag cm-bracket">></span></span>

